{% extends "index.html" %}

{% block content %}

<h2 class="text-2xl font-bold mb-6">Billing Page</h2>

<form method="POST" id="billingForm" class="space-y-6">
    {% csrf_token %}

    <div>
        <label class="block font-medium mb-1">Customer Email</label>
        <input type="email" name="customer_email" placeholder="Customer Email Address"
               class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-200">
        <p class="text-red-500 text-sm mt-1 hidden" id="emailError"></p>
    </div>

    <div id="products" class="space-y-4">
        <div class="grid grid-cols-2 gap-4 product-row">
            <input type="text" name="product_id" placeholder="Product ID"
                   class="border rounded-lg p-2">
            <input type="number" name="quantity" placeholder="Quantity"
                   class="border rounded-lg p-2" min="1">
        </div>
    </div>

    <button type="button" onclick="addField()"
            class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">
        Add Product
    </button>

    <hr class="my-6">

    <h3 class="text-lg font-semibold">Denominations Available</h3>

    <div class="grid grid-cols-4 gap-4">
        {% for denom in denominations %}
        <div>
            <label class="block text-sm mb-2 font-semibold ">{{ denom }}</label>
            <input type="number" name="denom_{{ denom }}"
                   class="border rounded-lg p-2 w-full denomField" placeholder="Count">
        </div>
        {% endfor %}
    </div>

    <div>
        <label class="block font-medium mt-4 mb-1">Amount Paid</label>
        <input type="number" name="amount_paid" placeholder="Enter Amount Paid"
               class="w-full border rounded-lg p-2"
               required>
    </div>

    <button type="submit"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        Generate Bill
    </button>
</form>

<script>

$(document).ready(function () {

    $("#billingForm").validate({

        errorClass: "text-red-500 text-sm mt-1",
        highlight: function (element) {
            $(element).addClass("border-red-500");
        },
        unhighlight: function (element) {
            $(element).removeClass("border-red-500");
        },

        rules: {
            customer_email: {
                required: true,
                email: true
            },
            amount_paid: {
                required: true,
                number: true,
                min: 1
            }
        },

        messages: {
            customer_email: {
                required: "Email is required",
                email: "Enter valid email"
            },
            amount_paid: {
                required: "Amount is required",
                min: "Amount must be greater than 0"
            }
        },

        submitHandler: function (form) {

            $(".text-red-500").remove(); // Clear previous error messages

            // Validate dynamic product rows
            let validProduct = false;
            let hasError = false;

            $(".product-row").each(function () {
                const pid = $(this).find("input[name='product_id']");
                const qty = $(this).find("input[name='quantity']");

                if (pid.val().trim() !== "" || qty.val().trim() !== "") {

                    validProduct = true;

                    if (pid.val().trim() === "") {
                        pid.after("<label class='text-red-500 text-sm'>Product ID required</label>");
                        hasError = true;
                    }

                    if (qty.val().trim() === "" || qty.val() <= 0) {
                        qty.after("<label class='text-red-500 text-sm'>Quantity must be > 0</label>");
                        hasError = true;
                    }
                }
            });

            if (!validProduct) {
                alert("Add at least one product.");
                return false;
            }

            // Validate denominations
            $(".denomField").each(function () {
                if ($(this).val() < 0) {
                    $(this).after("<label class='text-red-500 text-sm'>Cannot be negative</label>");
                    hasError = true;
                }
            });

            if (!hasError) {
                form.submit();
            }
        }

    });

});

function addField() {
    const container = document.getElementById("products");

    const row = document.createElement("div");
    row.className = "grid grid-cols-2 gap-4 product-row mt-2";

    const productInput = document.createElement("input");
    productInput.type = "text";
    productInput.name = "product_id";
    productInput.placeholder = "Product ID";
    productInput.className = "border rounded-lg p-2";

    const quantityInput = document.createElement("input");
    quantityInput.type = "number";
    quantityInput.name = "quantity";
    quantityInput.placeholder = "Quantity";
    quantityInput.className = "border rounded-lg p-2";
    quantityInput.min = "1";

    row.appendChild(productInput);
    row.appendChild(quantityInput);

    container.appendChild(row);
}
</script>

{% endblock %}